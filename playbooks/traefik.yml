---
- name: Config traefik service
  hosts: traefik
  vars:
    domain: "{{ lookup('env', 'DOMAIN') }}"
    acme_cert_email: "{{ lookup('env', 'ACME_CERT_EMAIL') }}"
    acme_letsencrypt_url: "{{ lookup('env', 'ACME_LETSENCRYPT_URL') }}"
    path: "{{ lookup('env', 'VOL_PATH') }}"
  tasks:
    - name: Make directories
      ansible.builtin.file:
        path: "{{ path }}/{{ item }}"
        state: directory
        mode: '0700'
      loop:
        - traefik
        - traefik/certificates
        - traefik/config
        - traefik/config/dynamic
      become: true
      become_user: root

    - name: Copy files
      ansible.builtin.template:
        src: "../services/traefik/config/{{ item }}"
        dest: "{{ path }}/traefik/config/{{ item }}"
        mode: '0644'
      loop:
        - traefik.yml
        - dynamic/secure-headers.yml
        - dynamic/tls.yml
      become: true
      become_user: root

    - name: Copy files
      ansible.builtin.template:
        src: "../services/traefik/config/dynamic/{{ item }}"
        dest: "{{ path }}/traefik/config/dynamic/{{ item }}"
        mode: '0644'
      loop:
        - oberon.yml
        - fallback.yml
        - catch-all.yml
      become: true
      become_user: root
      when: inventory_hostname == 'calisto'
